import { useState, useCallback, useRef } from "react";
import { motion } from "framer-motion";
import { Bug, Play, Square, Download, ShieldAlert, ShieldCheck, CheckCircle2 } from "lucide-react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Progress } from "@/components/ui/progress";
import TerminalLog, { LogEntry } from "@/components/TerminalLog";
import SeverityBadge from "@/components/SeverityBadge";
import { runScan, ScanResult } from "@/lib/scanner";
import { generateScanPDF } from "@/lib/pdf-generator";

const VulnerabilityPage = () => {
  const [url, setUrl] = useState("");
  const [consent, setConsent] = useState(false);
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [terminalOpen, setTerminalOpen] = useState(false);
  const [result, setResult] = useState<ScanResult | null>(null);
  const abortRef = useRef<AbortController | null>(null);

  const addLog = useCallback((log: Omit<LogEntry, "id">) => {
    setLogs((prev) => [...prev, { ...log, id: `${Date.now()}-${Math.random()}` }]);
  }, []);

  const handleStart = async () => {
    if (!url.trim() || !consent) return;
    setIsRunning(true);
    setResult(null);
    setLogs([]);
    setTerminalOpen(true);
    setProgress(0);

    abortRef.current = new AbortController();

    const interval = setInterval(() => {
      setProgress((p) => Math.min(p + 1.5, 95));
    }, 400);

    try {
      const res = await runScan(url, addLog, abortRef.current.signal);
      setResult(res);
      setProgress(100);
    } catch {
      addLog({ timestamp: new Date().toLocaleTimeString("en-US", { hour12: false }), message: "Scan failed", type: "error" });
    } finally {
      clearInterval(interval);
      setIsRunning(false);
    }
  };

  const handleStop = () => {
    abortRef.current?.abort();
  };

  const riskColor: Record<string, string> = {
    Low: "text-severity-low",
    Medium: "text-severity-medium",
    High: "text-severity-high",
    Critical: "text-severity-critical",
  };

  return (
    <div className="max-w-5xl mx-auto space-y-8">
      {/* Header */}
      <div className="space-y-2">
        <div className="flex items-center gap-3">
          <Bug className="w-8 h-8 text-neon-cyan" />
          <h1 className="text-3xl font-bold text-foreground">
            Vulnerability <span className="text-neon-cyan text-glow-cyan">Scanner</span>
          </h1>
        </div>
        <p className="text-muted-foreground font-mono text-sm">
          Non-destructive security assessment with pattern-based vulnerability detection
        </p>
      </div>

      {/* Config Panel */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        className="rounded-xl border border-border bg-card p-6 space-y-5"
      >
        <div className="space-y-2">
          <label className="text-sm font-mono text-muted-foreground">Target URL</label>
          <Input
            value={url}
            onChange={(e) => setUrl(e.target.value)}
            placeholder="https://example.com"
            className="font-mono bg-muted/50 border-border focus:border-accent"
            disabled={isRunning}
          />
        </div>

        {/* Legal Disclaimer */}
        <div className="rounded-lg border border-neon-orange/30 bg-neon-orange/5 p-4 space-y-3">
          <div className="flex items-start gap-2">
            <ShieldAlert className="w-5 h-5 text-neon-orange mt-0.5 shrink-0" />
            <div className="space-y-1">
              <p className="text-sm font-semibold text-neon-orange">Legal Disclaimer</p>
              <p className="text-xs text-muted-foreground leading-relaxed">
                This tool performs <strong>non-destructive, passive security checks only</strong>. 
                By proceeding, you confirm that you have authorization to scan the target URL. 
                Unauthorized scanning of systems you do not own or have permission to test is illegal.
                No brute force, no exploitation, no destructive testing will be performed.
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2 pl-7">
            <Checkbox
              id="consent"
              checked={consent}
              onCheckedChange={(checked) => setConsent(checked === true)}
              disabled={isRunning}
            />
            <label htmlFor="consent" className="text-xs font-mono text-muted-foreground cursor-pointer">
              I confirm I have authorization to scan this target
            </label>
          </div>
        </div>

        <div className="flex gap-3">
          <Button
            onClick={handleStart}
            disabled={isRunning || !url.trim() || !consent}
            className="bg-accent text-accent-foreground hover:bg-accent/90 font-mono gap-2"
          >
            <Play className="w-4 h-4" /> Start Scan
          </Button>
          {isRunning && (
            <Button
              onClick={handleStop}
              variant="outline"
              className="border-destructive text-destructive hover:bg-destructive/10 font-mono gap-2"
            >
              <Square className="w-4 h-4" /> Stop
            </Button>
          )}
          <Button
            onClick={() => setTerminalOpen(!terminalOpen)}
            variant="outline"
            className="font-mono gap-2 ml-auto border-border text-muted-foreground hover:text-foreground"
          >
            Terminal {logs.length > 0 && `(${logs.length})`}
          </Button>
        </div>

        {(isRunning || progress > 0) && (
          <div className="space-y-2">
            <div className="flex justify-between text-xs font-mono text-muted-foreground">
              <span>{isRunning ? "Scanning..." : "Complete"}</span>
              <span>{Math.round(progress)}%</span>
            </div>
            <Progress value={progress} className="h-2 bg-muted [&>div]:bg-accent" />
          </div>
        )}
      </motion.div>

      {/* Results */}
      {result && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="space-y-6"
        >
          {/* Risk Score */}
          <div className="rounded-xl border border-border bg-card p-6 flex items-center justify-between">
            <div className="space-y-1">
              <p className="text-sm font-mono text-muted-foreground">Overall Risk Score</p>
              <p className={`text-4xl font-bold font-mono ${riskColor[result.risk_score] || "text-foreground"}`}>
                {result.risk_score}
              </p>
            </div>
            <div className="text-right space-y-1">
              <p className="text-sm font-mono text-muted-foreground">Vulnerabilities Found</p>
              <p className="text-4xl font-bold font-mono text-foreground">{result.vulnerabilities_found.length}</p>
            </div>
            <div className="text-right space-y-1">
              <p className="text-sm font-mono text-muted-foreground">Scan Duration</p>
              <p className="text-2xl font-bold font-mono text-muted-foreground">{result.scan_time}</p>
            </div>
          </div>

          {/* Vulnerabilities */}
          {result.vulnerabilities_found.length > 0 && (
            <div className="rounded-xl border border-border bg-card overflow-hidden">
              <div className="px-5 py-3 border-b border-border bg-muted/30 flex items-center gap-2">
                <ShieldAlert className="w-4 h-4 text-destructive" />
                <h3 className="font-mono text-sm text-foreground">Vulnerabilities</h3>
              </div>
              <div className="divide-y divide-border/50">
                {result.vulnerabilities_found.map((vuln, i) => (
                  <div key={i} className="p-4 hover:bg-muted/20 transition-colors space-y-2">
                    <div className="flex items-center justify-between">
                      <span className="font-mono text-sm text-foreground font-semibold">{vuln.type}</span>
                      <SeverityBadge severity={vuln.severity} />
                    </div>
                    <p className="text-xs text-muted-foreground">{vuln.description}</p>
                    <div className="rounded bg-terminal-bg p-2 font-mono text-xs text-terminal-text">
                      Evidence: {vuln.evidence}
                    </div>
                    <p className="text-xs text-primary/80">
                      <strong>Fix:</strong> {vuln.recommendation}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Security Headers */}
          <div className="rounded-xl border border-border bg-card overflow-hidden">
            <div className="px-5 py-3 border-b border-border bg-muted/30 flex items-center gap-2">
              <ShieldCheck className="w-4 h-4 text-primary" />
              <h3 className="font-mono text-sm text-foreground">Security Headers</h3>
            </div>
            <div className="divide-y divide-border/50">
              {Object.entries(result.security_headers).map(([header, value]) => (
                <div key={header} className="px-5 py-3 flex items-center justify-between font-mono text-xs">
                  <span className="text-muted-foreground">{header}</span>
                  <div className="flex items-center gap-2">
                    <span className={value === "Not Set" ? "text-neon-orange" : "text-primary"}>
                      {value}
                    </span>
                    {value !== "Not Set" ? (
                      <CheckCircle2 className="w-3.5 h-3.5 text-primary" />
                    ) : (
                      <ShieldAlert className="w-3.5 h-3.5 text-neon-orange" />
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Download */}
          <Button
            onClick={() => generateScanPDF(result)}
            className="bg-accent text-accent-foreground hover:bg-accent/90 font-mono gap-2"
          >
            <Download className="w-4 h-4" /> Download PDF Report
          </Button>
        </motion.div>
      )}

      <TerminalLog logs={logs} title="Scanner Terminal" isOpen={terminalOpen} onClose={() => setTerminalOpen(false)} />
    </div>
  );
};

export default VulnerabilityPage;

import { useState, useCallback, useRef } from "react";
import { motion } from "framer-motion";
import { Bug, Play, Square, Download, ShieldAlert, ShieldCheck, CheckCircle2, ArrowLeft, Globe, MapPin, Lock, Code, Server, Cpu, Network, Database } from "lucide-react";
import { Link } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Checkbox } from "@/components/ui/checkbox";
import { Progress } from "@/components/ui/progress";
import TerminalLog, { LogEntry } from "@/components/TerminalLog";
import SeverityBadge from "@/components/SeverityBadge";
import { runScan, ScanResult } from "@/lib/scanner";
import { generateScanPDF } from "@/lib/pdf-generator";

const VulnerabilityPage = () => {
  const [url, setUrl] = useState("");
  const [consent, setConsent] = useState(false);
  const [isRunning, setIsRunning] = useState(false);
  const [progress, setProgress] = useState(0);
  const [logs, setLogs] = useState<LogEntry[]>([]);
  const [terminalOpen, setTerminalOpen] = useState(false);
  const [result, setResult] = useState<ScanResult | null>(null);
  const abortRef = useRef<AbortController | null>(null);

  const addLog = useCallback((log: Omit<LogEntry, "id">) => {
    setLogs((prev) => [...prev, { ...log, id: `${Date.now()}-${Math.random()}` }]);
  }, []);

  const handleStart = async () => {
    if (!url.trim() || !consent) return;
    setIsRunning(true);
    setResult(null);
    setLogs([]);
    setTerminalOpen(true);
    setProgress(0);

    abortRef.current = new AbortController();

    const interval = setInterval(() => {
      setProgress((p) => Math.min(p + 1.5, 95));
    }, 400);

    try {
      const res = await runScan(url, addLog, abortRef.current.signal);
      setResult(res);
      setProgress(100);
    } catch {
      addLog({ timestamp: new Date().toLocaleTimeString("en-US", { hour12: false }), message: "Scan failed", type: "error" });
    } finally {
      clearInterval(interval);
      setIsRunning(false);
    }
  };

  const handleStop = () => {
    abortRef.current?.abort();
  };

  const riskColor: Record<string, string> = {
    Low: "text-severity-low",
    Medium: "text-severity-medium",
    High: "text-severity-high",
    Critical: "text-severity-critical",
  };

  return (
    <div className="max-w-5xl mx-auto space-y-8">
      {/* Breadcrumb */}
      <Link to="/" className="inline-flex items-center gap-2 text-xs font-mono text-muted-foreground hover:text-primary transition-colors">
        <ArrowLeft className="w-3 h-3" /> Back to Home
      </Link>

      {/* Header */}
      <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} className="space-y-2">
        <div className="flex items-center gap-3">
          <div className="relative">
            <Bug className="w-8 h-8 text-neon-cyan" />
            <div className="absolute inset-0 bg-neon-cyan/20 blur-xl rounded-full" />
          </div>
          <h1 className="text-3xl font-bold text-foreground">
            Vulnerability <span className="text-neon-cyan text-glow-cyan">Scanner</span>
          </h1>
        </div>
        <p className="text-muted-foreground font-mono text-sm">
          Non-destructive security assessment with pattern-based vulnerability detection
        </p>
      </motion.div>

      {/* Config Panel */}
      <motion.div
        initial={{ opacity: 0, y: 10 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.1 }}
        className="rounded-xl border border-border bg-card/60 backdrop-blur-sm p-6 space-y-5 hover:border-accent/20 transition-colors duration-300"
      >
        <div className="space-y-2">
          <label className="text-sm font-mono text-muted-foreground">Target URL</label>
          <Input
            value={url}
            onChange={(e) => setUrl(e.target.value)}
            placeholder="https://example.com"
            className="font-mono bg-muted/50 border-border focus:border-accent h-11"
            disabled={isRunning}
          />
        </div>

        {/* Legal Disclaimer */}
        <div className="rounded-lg border border-neon-orange/30 bg-neon-orange/5 p-4 space-y-3">
          <div className="flex items-start gap-2">
            <ShieldAlert className="w-5 h-5 text-neon-orange mt-0.5 shrink-0" />
            <div className="space-y-1">
              <p className="text-sm font-semibold text-neon-orange">Legal Disclaimer</p>
              <p className="text-xs text-muted-foreground leading-relaxed">
                This tool performs <strong>non-destructive, passive security checks only</strong>. 
                By proceeding, you confirm that you have authorization to scan the target URL. 
                Unauthorized scanning of systems you do not own or have permission to test is illegal.
              </p>
            </div>
          </div>
          <div className="flex items-center gap-2 pl-7">
            <Checkbox
              id="consent"
              checked={consent}
              onCheckedChange={(checked) => setConsent(checked === true)}
              disabled={isRunning}
            />
            <label htmlFor="consent" className="text-xs font-mono text-muted-foreground cursor-pointer">
              I confirm I have authorization to scan this target
            </label>
          </div>
        </div>

        <div className="flex gap-3 pt-2">
          <Button
            onClick={handleStart}
            disabled={isRunning || !url.trim() || !consent}
            className="bg-accent text-accent-foreground hover:bg-accent/90 font-mono gap-2 h-11 px-6"
          >
            <Play className="w-4 h-4" /> Start Scan
          </Button>
          {isRunning && (
            <Button
              onClick={handleStop}
              variant="outline"
              className="border-destructive text-destructive hover:bg-destructive/10 font-mono gap-2 h-11"
            >
              <Square className="w-4 h-4" /> Stop
            </Button>
          )}
          <Button
            onClick={() => setTerminalOpen(!terminalOpen)}
            variant="outline"
            className="font-mono gap-2 ml-auto border-border text-muted-foreground hover:text-foreground h-11"
          >
            Terminal {logs.length > 0 && `(${logs.length})`}
          </Button>
        </div>

        {(isRunning || progress > 0) && (
          <div className="space-y-2">
            <div className="flex justify-between text-xs font-mono text-muted-foreground">
              <span>{isRunning ? "Scanning..." : "Complete"}</span>
              <span>{Math.round(progress)}%</span>
            </div>
            <Progress value={progress} className="h-2 bg-muted [&>div]:bg-accent" />
          </div>
        )}
      </motion.div>

      {/* Results */}
      {result && (
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          className="space-y-6"
        >
          {/* Risk Score */}
          <div className="grid grid-cols-3 gap-4">
            {[
              { label: "Overall Risk", value: result.risk_score, color: riskColor[result.risk_score] || "text-foreground" },
              { label: "Vulnerabilities", value: String(result.vulnerabilities_found.length), color: "text-foreground" },
              { label: "Scan Duration", value: result.scan_time, color: "text-muted-foreground" },
            ].map((item, i) => (
              <motion.div
                key={item.label}
                initial={{ opacity: 0, scale: 0.9 }}
                animate={{ opacity: 1, scale: 1 }}
                transition={{ delay: i * 0.1 }}
                className="rounded-xl border border-border bg-card/50 backdrop-blur-sm p-5 text-center"
              >
                <p className="text-xs font-mono text-muted-foreground mb-2">{item.label}</p>
                <p className={`text-3xl font-bold font-mono ${item.color}`}>{item.value}</p>
              </motion.div>
            ))}
          </div>

          {/* Vulnerabilities */}
          {result.vulnerabilities_found.length > 0 && (
            <div className="rounded-xl border border-border bg-card/50 backdrop-blur-sm overflow-hidden">
              <div className="px-5 py-3 border-b border-border bg-muted/30 flex items-center gap-2">
                <ShieldAlert className="w-4 h-4 text-destructive" />
                <h3 className="font-mono text-sm text-foreground">Vulnerabilities</h3>
                <span className="ml-auto text-xs font-mono text-muted-foreground">{result.vulnerabilities_found.length} found</span>
              </div>
              <div className="divide-y divide-border/50">
                {result.vulnerabilities_found.map((vuln, i) => (
                  <motion.div
                    key={i}
                    initial={{ opacity: 0, x: -10 }}
                    animate={{ opacity: 1, x: 0 }}
                    transition={{ delay: i * 0.05 }}
                    className="p-4 hover:bg-muted/20 transition-colors space-y-3"
                  >
                    <div className="flex items-center justify-between">
                      <span className="font-mono text-sm text-foreground font-semibold">{vuln.type}</span>
                      <SeverityBadge severity={vuln.severity} />
                    </div>
                    <p className="text-xs text-muted-foreground leading-relaxed">{vuln.description}</p>
                    <div className="rounded-lg bg-terminal-bg p-3 font-mono text-xs text-terminal-text border border-terminal-border">
                      <span className="text-muted-foreground/50">evidence:</span> {vuln.evidence}
                    </div>
                    <p className="text-xs text-primary/80">
                      <span className="text-primary font-semibold">→ Fix:</span> {vuln.recommendation}
                    </p>
                  </motion.div>
                ))}
              </div>
            </div>
          )}

          {/* Security Headers */}
          <div className="rounded-xl border border-border bg-card/50 backdrop-blur-sm overflow-hidden">
            <div className="px-5 py-3 border-b border-border bg-muted/30 flex items-center gap-2">
              <ShieldCheck className="w-4 h-4 text-primary" />
              <h3 className="font-mono text-sm text-foreground">Security Headers</h3>
            </div>
            <div className="divide-y divide-border/50">
              {Object.entries(result.security_headers).map(([header, value]) => (
                <div key={header} className="px-5 py-3 flex items-center justify-between font-mono text-xs hover:bg-muted/10 transition-colors">
                  <span className="text-muted-foreground">{header}</span>
                  <div className="flex items-center gap-2">
                    <span className={value === "Not Set" ? "text-neon-orange" : "text-primary"}>
                      {value}
                    </span>
                    {value !== "Not Set" ? (
                      <CheckCircle2 className="w-3.5 h-3.5 text-primary" />
                    ) : (
                      <ShieldAlert className="w-3.5 h-3.5 text-neon-orange" />
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Recon Intel */}
          {result.recon_intel && (
            <div className="space-y-4">
              <div className="flex items-center gap-2 mb-2">
                <Cpu className="w-5 h-5 text-neon-cyan" />
                <h2 className="text-lg font-bold font-mono text-foreground">Reconnaissance <span className="text-neon-cyan">Intel</span></h2>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {/* IP Address */}
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.05 }}
                  className="rounded-xl border border-border bg-card/50 backdrop-blur-sm p-5 space-y-3">
                  <div className="flex items-center gap-2 text-sm font-mono text-neon-cyan">
                    <Globe className="w-4 h-4" /> IP Address
                  </div>
                  <div className="space-y-1">
                    {(result.recon_intel.ip_addresses || []).map((ip, i) => (
                      <p key={i} className="font-mono text-lg font-bold text-foreground">{ip}</p>
                    ))}
                  </div>
                </motion.div>

                {/* Server Location */}
                {result.recon_intel.geolocation && (
                  <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }}
                    className="rounded-xl border border-border bg-card/50 backdrop-blur-sm p-5 space-y-3">
                    <div className="flex items-center gap-2 text-sm font-mono text-neon-cyan">
                      <MapPin className="w-4 h-4" /> Server Location
                    </div>
                    <p className="font-mono text-lg font-bold text-foreground">
                      {result.recon_intel.geolocation.city}, {result.recon_intel.geolocation.region}
                    </p>
                    <div className="space-y-1 text-xs font-mono text-muted-foreground">
                      <p>Country: <span className="text-foreground">{result.recon_intel.geolocation.country}</span></p>
                      <p>ISP: <span className="text-foreground">{result.recon_intel.geolocation.isp}</span></p>
                      <p>Org: <span className="text-foreground">{result.recon_intel.geolocation.org}</span></p>
                      <p>AS: <span className="text-foreground">{result.recon_intel.geolocation.as_number}</span></p>
                      {result.recon_intel.geolocation.lat && (
                        <p>Coords: <span className="text-foreground">{result.recon_intel.geolocation.lat}, {result.recon_intel.geolocation.lon}</span></p>
                      )}
                    </div>
                  </motion.div>
                )}

                {/* SSL Certificate */}
                {result.recon_intel.ssl_certificate && (
                  <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.15 }}
                    className="rounded-xl border border-border bg-card/50 backdrop-blur-sm p-5 space-y-3">
                    <div className="flex items-center gap-2 text-sm font-mono text-neon-cyan">
                      <Lock className="w-4 h-4" /> SSL/TLS Certificate
                    </div>
                    <div className="space-y-1 text-xs font-mono text-muted-foreground">
                      <p>Issuer: <span className="text-foreground font-semibold">{result.recon_intel.ssl_certificate.issuer}</span></p>
                      <p>Subject: <span className="text-foreground">{result.recon_intel.ssl_certificate.subject}</span></p>
                      {result.recon_intel.ssl_certificate.valid_from && (
                        <p>Valid From: <span className="text-foreground">{result.recon_intel.ssl_certificate.valid_from}</span></p>
                      )}
                      {result.recon_intel.ssl_certificate.valid_to && (
                        <p>Valid To: <span className="text-foreground">{result.recon_intel.ssl_certificate.valid_to}</span></p>
                      )}
                      {result.recon_intel.ssl_certificate.protocol && (
                        <p>Protocol: <span className="text-foreground">{result.recon_intel.ssl_certificate.protocol}</span></p>
                      )}
                    </div>
                  </motion.div>
                )}

                {/* Technologies Detected */}
                {result.recon_intel.technologies && result.recon_intel.technologies.length > 0 && (
                  <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }}
                    className="rounded-xl border border-border bg-card/50 backdrop-blur-sm p-5 space-y-3">
                    <div className="flex items-center gap-2 text-sm font-mono text-neon-cyan">
                      <Code className="w-4 h-4" /> Technologies & Stack
                    </div>
                    <div className="flex flex-wrap gap-2">
                      {result.recon_intel.technologies.map((tech, i) => (
                        <span key={i} className="px-2.5 py-1 rounded-md bg-accent/10 border border-accent/20 text-xs font-mono text-accent">
                          {tech}
                        </span>
                      ))}
                    </div>
                  </motion.div>
                )}
              </div>

              {/* Technical Details - Full Width */}
              {result.recon_intel.technical && (
                <motion.div initial={{ opacity: 0, y: 10 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.25 }}
                  className="rounded-xl border border-border bg-card/50 backdrop-blur-sm overflow-hidden">
                  <div className="px-5 py-3 border-b border-border bg-muted/30 flex items-center gap-2">
                    <Server className="w-4 h-4 text-neon-cyan" />
                    <h3 className="font-mono text-sm text-foreground">Technical Profile</h3>
                  </div>
                  <div className="grid grid-cols-2 md:grid-cols-3 divide-x divide-border/30">
                    {[
                      { label: "HTTP Status", value: String(result.recon_intel.technical.http_status), icon: <Network className="w-3 h-3" /> },
                      { label: "Protocol", value: result.recon_intel.technical.protocol, icon: <Lock className="w-3 h-3" /> },
                      { label: "Content-Type", value: result.recon_intel.technical.content_type.split(";")[0], icon: <Code className="w-3 h-3" /> },
                      { label: "Content Size", value: result.recon_intel.technical.content_length, icon: <Database className="w-3 h-3" /> },
                      { label: "Internal Endpoints", value: String(result.recon_intel.technical.internal_endpoints), icon: <Globe className="w-3 h-3" /> },
                      { label: "External Domains", value: String(result.recon_intel.technical.external_domains), icon: <Globe className="w-3 h-3" /> },
                    ].map((item, i) => (
                      <div key={i} className="px-4 py-3 space-y-1">
                        <div className="flex items-center gap-1.5 text-[10px] font-mono text-muted-foreground uppercase">
                          {item.icon} {item.label}
                        </div>
                        <p className="font-mono text-sm font-semibold text-foreground truncate" title={item.value}>{item.value}</p>
                      </div>
                    ))}
                  </div>
                  {result.recon_intel.technical.redirected && (
                    <div className="px-5 py-2 border-t border-border/30 text-xs font-mono text-muted-foreground">
                      Redirected → <span className="text-foreground">{result.recon_intel.technical.final_url}</span>
                    </div>
                  )}
                </motion.div>
              )}
            </div>
          )}

          {/* Download */}
          <Button
            onClick={() => generateScanPDF(result)}
            className="bg-accent text-accent-foreground hover:bg-accent/90 font-mono gap-2 h-11"
          >
            <Download className="w-4 h-4" /> Download PDF Report
          </Button>
        </motion.div>
      )}

      <TerminalLog logs={logs} title="Scanner Terminal" isOpen={terminalOpen} onClose={() => setTerminalOpen(false)} />
    </div>
  );
};

export default VulnerabilityPage;
